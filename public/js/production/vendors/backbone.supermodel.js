(function(e,t){if(typeof exports=="object"){var n=require("underscore"),r=require("backbone");module.exports=t(n,r)}else typeof define=="function"&&define.amd&&define(["underscore","backbone"],t)})(this,function(e,t){return t.SuperModel=function(e,t){var n=function(t){return e.isString(t)&&(t=t.split(".")),t},r=function(e,t,r){t=n(t);var i=t.length;for(var s=0;s<i;s++){if(!e||typeof e!="object")return r;e=e[t[s]]}return e===undefined?r:e},i=function(e,t,r){t=n(t),lastKeyIndex=t.length-1;for(var i=0;i<lastKeyIndex;++i)key=t[i],key in e||(e[key]={}),e=e[key];r(e,t[lastKeyIndex])},s=function(e,t,n){i(e,t,function(e,t){e[t]=n})},o=function(e,t){i(e,t,function(e,t){delete e[t]})},u=function(t,n){var r=!1;return i(t,n,function(t,n){r=e.has(t,n)}),r},a=function(r,i,s){i=n(i);var o=e.first(i),u=r.get(o);u instanceof t.Model?a(u,e.rest(i),s):s(r,i)},f=function(t,n,r){var i;if(n){var s=e.result(t,"relations");i=s[n]}return r&&!i&&(i=h),i==void 0&&(i=h),i},l=function(t,n,r){var i=e.result(t,"name");return i&&!n[i]&&(n[i]=t),n},c=function(e){return Object.getPrototypeOf(Object.getPrototypeOf(e))===null},h=t.Model.extend({relations:{},unsafeAttributes:[],name:null,_valueForCollection:function(t){return e.isArray(t)?t.length>=1?e.isObject(t[0]):!0:!1},_nestedSet:function(n,r,i){n=n.split(".");var s=n.length-1,o=this;for(var u=0;u<s;++u){var a=n[u],h=o.attributes[a];if(!h){var d=f(o,a,r),v=new d;o.attributes[a]=l(o,v,i)}o=o.attributes[a]}var m=n[s];if(!e.isArray(r)&&e.isObject(r)&&c(r))for(var g in r){var y=m+"."+g;o._nestedSet(y,r[g],i)}else if(this._valueForCollection(r)){var b=f(o,m,r);b.prototype instanceof t.Model&&(b=p);var w=new b(r);w=l(o,w,i),o.attributes[m]=w}else n.length==1?o.attributes[m]=r:o.set(m,r,e.extend({skipNested:!0,forceChange:!0},i))},_setChanging:function(){this._previousAttributes=this.toJSON(),this.changed={}},_triggerChanges:function(e,t,n){e.length&&(this._pending=!0);for(var r=0,i=e.length;r<i;r++)n||(n=this.get(e[r])),this.trigger("change:"+e[r],this,n,t)},_setChange:function(t,n,r){var i=this.get(t);return t=t.split("."),!e.isEqual(i,n)||r.forceChange?(s(this.changed,t,n),!0):(o(this.changed,t),!1)},set:function(e,t,n){var r,i,s,o,u,f,l,c,h;if(e==null)return this;typeof e=="object"?(i=e,n=t):(i={},i[e]=t),n=n||{};if(!this._validate(i,n))return!1;s=n.unset,u=n.silent,o=[],f=this._changing,h=n.skipNested,this._changing=!0,f||this._setChanging(),this.idAttribute in i&&(this.id=i[this.idAttribute]);var p=function(e,t){delete e.attributes[t]};for(r in i)t=i[r],this._setChange(r,t,n)&&o.push(r),s?a(this,r,p):h?this.attributes[r]=t:this._nestedSet(r,t,n);u||this._triggerChanges(o,n);if(f)return this;if(!u)while(this._pending)this._pending=!1,this.trigger("change",this,n);return this._pending=!1,this._changing=!1,this},get:function(t){var n=t.split(".");if(n.length>1){var r=this.attributes[e.first(n)];if(!r)return;var i=e.rest(n).join(".");return e.isFunction(r.get)?r.get(i):r[i]}return this.attributes[t]},toJSON:function(t){t=t||{};var n=e.result(this,"unsafeAttributes");t.except&&(n=e.union(n,t.except));var r=e.clone(this.attributes);return e.each(n,function(e){delete r[e]}),e.each(r,function(t,n){t&&e.isFunction(t.toJSON)&&(r[n]=t.toJSON())}),r},hasChanged:function(t){return t==null?!e.isEmpty(this.changed):u(this.changed,t)},previous:function(e){return e==null||!this._previousAttributes?null:r(this._previousAttributes,e)},clear:function(e){var n={};this.id=void 0;for(var r in this.attributes){var i=this.attributes[r];i instanceof t.Model?i.clear():i instanceof t.Collection?i.reset():this.unset(r)}}}),p=t.Collection.extend({model:h});return h}(e,t),t.SuperModel});