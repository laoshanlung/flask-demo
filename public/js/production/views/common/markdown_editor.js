define(["underscore.custom","marionette.custom","views/mixins/model_binding","text!templates/common/markdown_editor.html","vendors/codemirror","vendors/marked","vendors/highlight"],function(e,t,n,r,i,s){var o=t.ItemView.extend({template:function(t){return e.template(r,t)},theme:"blackboard",height:"450px",width:"100%",showToolbar:!0,lineNumbers:!0,events:{"click .js-editor-control button":"onChangeMode","click .js-change-theme":"onChangeTheme"},ui:{editor:".js-editor",control:".js-editor-control",preview:".js-editor-preview"},initialize:function(){this._changing=!1;var e=t.getOption(this,"attribute");this.listenTo(this.model,"change:"+e,this.onChangeModelValue)},onRender:function(){var e=t.getOption(this,"attribute"),n=this;this.$el.css("min-height",t.getOption(this,"height")),this.$el.width(t.getOption(this,"width"));var r=i(this.ui.editor[0],{indentUnit:2,indentWithTabs:!1,mode:"markdown",lineNumbers:t.getOption(this,"lineNumbers")});r.setOption("theme",t.getOption(this,"theme")),r.on("change",function(e,t){n.runOnce(function(){n._changing=!0,n.setModelValue(n.getValue()),n._changing=!1},1e3)}),this.codemirror=r;var s=t.getOption(this,"showToolbar");s||this.ui.control.remove(),this.adjustSize(),this.setValue(this.getModelValue()),$(window).resize(function(){clearTimeout($(this).data(n.cid)),$(this).data(n.cid,setTimeout(function(){n.adjustSize()},300))})},onChangeTheme:function(e){var t=$(e.currentTarget),n=t.data("theme");this.codemirror.setOption("theme",n),e.preventDefault()},onChangeMode:function(e){var t=$(e.currentTarget),n=t.data("mode");n&&(this.ui.control.find(".active").removeClass("active"),t.addClass("active"));switch(n){case"markdown":this.ui.preview.hide(),this.ui.editor.show();break;case"preview":this.ui.editor.hide(),this.triggerMethod("preview");break;default:}},onChangeModelValue:function(e,t){if(this._changing)return;this.setValue(t)},onPreview:function(){var e=this.codemirror.getValue(),t=s(e,{renderer:s.getRenderer("article")});this.ui.preview.html(t),this.ui.preview.show()},getValue:function(){return this.codemirror.getValue()},setValue:function(t){return e.isUndefined(t)||this.codemirror.setValue(t),this},show:function(){this.$el.show()},hide:function(){this.$el.hide()},adjustSize:function(){this.codemirror.setSize(this.ui.editor.width(),this.$el.height()-this.ui.control.height())}});return e.extend(o.prototype,n),o});